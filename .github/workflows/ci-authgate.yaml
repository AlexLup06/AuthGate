name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "20"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Go setup
      # ------------------------------------------------------------
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # ------------------------------------------------------------
      # Node setup
      # ------------------------------------------------------------
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # ------------------------------------------------------------
      # Install frontend deps
      # ------------------------------------------------------------
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # ------------------------------------------------------------
      # templ generate
      # ------------------------------------------------------------
      - name: Install templ
        run: go install github.com/a-h/templ/cmd/templ@v0.3.819

      - name: Generate templ files
        run: |
          export PATH="$PATH:$(go env GOPATH)/bin"
          templ generate

      # ------------------------------------------------------------
      # Tailwind build
      # ------------------------------------------------------------
      - name: Build Tailwind CSS
        working-directory: frontend
        run: npm run build:css

      # ------------------------------------------------------------
      # TypeScript + Webpack
      # ------------------------------------------------------------
      - name: Build frontend bundle
        working-directory: frontend
        run: npm run build:webpack

      # ------------------------------------------------------------
      # Docker build
      # ------------------------------------------------------------
      - name: Build Docker image
        run: |
          docker build \
            -f docker/Dockerfile.prod \
            -t authgate:${{ github.sha }} \
            .
